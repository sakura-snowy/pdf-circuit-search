# 文档问答功能部署指南

## 📋 功能说明

文档问答功能已经完整开发完成，但尚未部署到腾讯云服务器。该功能基于 **DeepSeek AI** 模型，能够回答电路图中的连接性问题。

### 功能特性
- ✅ 基于 PDF 文本内容智能问答
- ✅ 支持电路连接性查询（例如："油门踏板连接到ECU的哪些针脚号"）
- ✅ 专业的电路图分析助手
- ✅ 自动截断过长内容以优化 token 使用

---

## 🔍 已实现的代码

### 后端实现

#### 1. AI 服务 (`backend/src/services/aiService.ts`)
- 集成 DeepSeek API
- 支持电路图文档问答
- 智能上下文管理（最大 8000 字符）
- 完善的错误处理机制

#### 2. 控制器 (`backend/src/controllers/pdfController.ts:118-160`)
- `askQuestion` 函数处理问答请求
- 自动提取 PDF 文本
- 调用 AI 服务生成答案

#### 3. 路由 (`backend/src/routes/index.ts:22`)
```javascript
router.post('/pdfs/:id/ask', askQuestion);
```

### 前端实现

#### 1. API 接口 (`frontend/src/api/index.ts:40-46`)
```typescript
askQuestion: async (id: string, question: string): Promise<QuestionResponse>
```

#### 2. UI 界面 (`frontend/src/pages/PDFViewerPage.tsx`)
- 问答输入框和按钮
- 加载状态显示
- 错误提示处理

---

## 🚀 部署步骤

### 步骤 1：配置 DeepSeek API 密钥

在腾讯云服务器上配置环境变量：

```bash
# 连接到腾讯云服务器
ssh root@118.25.82.127

# 编辑后端环境变量文件
cd /var/www/pdf-search/backend
nano .env
```

添加或确认以下配置：

```bash
PORT=3001
PDF_STORAGE_PATH=/var/www/pdf-search/pdfs
NODE_ENV=production

# DeepSeek API 配置
DEEPSEEK_API_KEY=sk-48e00700ab5e467fae0b6ca97ff584f5
```

> **注意**：你的 API 密钥已经在本地 `.env` 文件中配置好了，需要同步到服务器。

### 步骤 2：更新后端代码

```bash
# 在服务器上，进入项目目录
cd /var/www/pdf-search

# 拉取最新代码（如果使用 Git）
git pull origin main

# 或者手动上传文件
# 使用 scp 从本地上传到服务器
# scp -r backend root@118.25.82.127:/var/www/pdf-search/
```

### 步骤 3：安装依赖

```bash
cd /var/www/pdf-search/backend

# 安装新的依赖（axios）
npm install

# 或者使用已有的 package.json 安装
npm install axios
```

### 步骤 4：重新编译后端

```bash
cd /var/www/pdf-search/backend

# 编译 TypeScript 代码
npm run build
```

### 步骤 5：重启后端服务

```bash
# 使用 PM2 重启服务
pm2 restart pdf-backend

# 或者如果服务名称不同，先查看
pm2 list

# 查看日志确认启动成功
pm2 logs pdf-backend
```

### 步骤 6：验证后端 API

测试问答接口是否正常工作：

```bash
# 测试文档问答 API
curl -X POST http://localhost:3001/api/pdfs/{PDF_ID}/ask \
  -H "Content-Type: application/json" \
  -d '{"question": "这个文档的主要内容是什么？"}'
```

预期返回：
```json
{
  "success": true,
  "data": {
    "documentId": "xxx",
    "question": "这个文档的主要内容是什么？",
    "answer": "根据文档内容..."
  }
}
```

### 步骤 7：更新前端（如果前端未同步）

前端代码已经包含了问答功能的 UI，如果之前已经部署了前端，应该已经包含这个功能。如果需要更新：

```bash
cd /var/www/pdf-search/frontend

# 拉取最新代码
git pull origin main

# 重新构建前端
npm run build

# 如果使用 Nginx，重新部署静态文件
cp -r dist/* /var/www/html/
```

### 步骤 8：验证完整功能

1. 访问网站：http://118.25.82.127
2. 打开任意 PDF 文档
3. 在页面上找到"提问"按钮（带有问号图标）
4. 输入问题，例如："油门踏板连接到 ECU 的哪些针脚号？"
5. 点击搜索或按 Enter 键
6. 查看 AI 返回的答案

---

## 🛠️ 技术架构

### API 调用流程

```
用户提问
  ↓
前端发送 POST 请求
  ↓
/api/pdfs/:id/ask
  ↓
提取 PDF 文本内容
  ↓
调用 DeepSeek API
  ↓
返回 AI 生成的答案
  ↓
前端显示答案
```

### DeepSeek API 参数

```typescript
{
  model: "deepseek-chat",
  temperature: 0.1,          // 低温度确保回答准确
  max_tokens: 800,           // 限制回答长度
  stream: false              // 非流式响应
}
```

---

## ⚙️ 环境变量说明

| 变量名 | 说明 | 示例值 |
|--------|------|--------|
| `DEEPSEEK_API_KEY` | DeepSeek API 密钥 | `sk-48e00700...` |
| `PORT` | 后端服务端口 | `3001` |
| `PDF_STORAGE_PATH` | PDF 存储路径 | `/var/www/pdf-search/pdfs` |
| `NODE_ENV` | 运行环境 | `production` |

---

## 🔧 故障排查

### 问题 1：提示 "AI 服务未配置"

**原因**：`DEEPSEEK_API_KEY` 未设置或为空

**解决方法**：
```bash
# 检查环境变量
cd /var/www/pdf-search/backend
cat .env | grep DEEPSEEK

# 如果没有，添加 API 密钥
echo "DEEPSEEK_API_KEY=sk-48e00700ab5e467fae0b6ca97ff584f5" >> .env

# 重启服务
pm2 restart pdf-backend
```

### 问题 2：API 调用失败（401 错误）

**原因**：API 密钥无效或过期

**解决方法**：
1. 访问 https://platform.deepseek.com/
2. 登录并获取新的 API 密钥
3. 更新 `.env` 文件中的密钥
4. 重启服务

### 问题 3：API 调用超时

**原因**：网络问题或 API 响应慢

**解决方法**：
- 检查服务器网络连接
- 调整 `timeout` 参数（当前为 30 秒）
- 查看 PM2 日志：`pm2 logs pdf-backend`

### 问题 4：回答不准确

**原因**：PDF 文本提取不完整或问题描述不清晰

**解决方法**：
- 优化问题描述，提供更多上下文
- 调整 `aiService.ts` 中的 `maxContentLength` 参数
- 修改 `temperature` 参数（当前为 0.1）

---

## 📊 API 使用监控

### 查看 API 调用日志

```bash
# 查看后端日志
pm2 logs pdf-backend --lines 100

# 搜索 API 调用记录
pm2 logs pdf-backend | grep "DeepSeek API"
```

### 监控 API 额度

定期检查 DeepSeek 平台的 API 使用情况：
- 访问：https://platform.deepseek.com/usage
- 查看剩余额度和调用次数

---

## 💡 优化建议

1. **缓存机制**：对于相同的问题，可以缓存 AI 的回答，减少 API 调用次数
2. **内容预处理**：提取 PDF 时可以过滤无关内容，提高回答质量
3. **流式响应**：将 `stream: true` 改为流式响应，提升用户体验
4. **多模型支持**：可以支持多个 AI 模型（如 OpenAI、Claude 等）作为备选

---

## 📝 快速部署命令汇总

```bash
# 1. 登录服务器
ssh root@118.25.82.127

# 2. 进入项目目录
cd /var/www/pdf-search/backend

# 3. 配置 API 密钥（如果未配置）
echo "DEEPSEEK_API_KEY=sk-48e00700ab5e467fae0b6ca97ff584f5" >> .env

# 4. 更新代码（如果使用 Git）
git pull origin main

# 5. 安装依赖
npm install

# 6. 编译代码
npm run build

# 7. 重启服务
pm2 restart pdf-backend

# 8. 查看日志确认启动成功
pm2 logs pdf-backend --lines 50
```

---

## ✅ 验证清单

部署完成后，请依次验证以下项目：

- [ ] 环境变量已正确配置（`DEEPSEEK_API_KEY`）
- [ ] 后端服务已成功启动（`pm2 list` 显示 online）
- [ ] API 接口可访问（`/api/pdfs/:id/ask`）
- [ ] 前端页面显示"提问"按钮
- [ ] 能够成功提交问题并获得回答
- [ ] 回答内容准确且相关
- [ ] 错误处理正常（如 API 限流、网络问题等）

---

## 🎉 完成！

文档问答功能现已成功部署到腾讯云服务器。用户可以通过 http://118.25.82.127 访问并使用该功能。

如有任何问题，请查看：
- 后端日志：`pm2 logs pdf-backend`
- Nginx 日志：`/var/log/nginx/error.log`
- DeepSeek 平台：https://platform.deepseek.com/
