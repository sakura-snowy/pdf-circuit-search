# PDF电路图搜索系统 - 部署操作手册

## 第一步：准备服务器连接

### 1.1 获取服务器信息
在腾讯云控制台获取：
- 服务器公网IP：例如 `123.456.789.0`
- SSH登录用户名：通常是 `root` 或 `ubuntu`
- SSH密码或密钥文件

### 1.2 SSH登录服务器

**Windows用户**（使用PowerShell或CMD）：
```bash
ssh root@你的服务器IP
# 例如：ssh root@123.456.789.0
# 首次连接会提示是否信任，输入 yes
# 然后输入密码
```

**或使用SSH密钥**：
```bash
ssh -i 你的密钥文件.pem root@你的服务器IP
```

---

## 第二步：初始化服务器环境

### 2.1 更新系统
```bash
sudo apt update
sudo apt upgrade -y
```

### 2.2 安装Node.js 18
```bash
# 添加NodeSource仓库
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -

# 安装Node.js
sudo apt install -y nodejs

# 验证安装
node -v    # 应显示 v18.x.x
npm -v     # 应显示 npm版本
```

### 2.3 安装PM2（进程管理器）
```bash
sudo npm install -g pm2

# 验证安装
pm2 -v
```

### 2.4 安装Nginx
```bash
sudo apt install -y nginx

# 验证安装
nginx -v

# 启动Nginx
sudo systemctl start nginx
sudo systemctl enable nginx
```

### 2.5 配置防火墙
```bash
# 允许HTTP和SSH
sudo ufw allow 80/tcp
sudo ufw allow 22/tcp
sudo ufw allow 443/tcp  # 如果将来要用HTTPS
sudo ufw --force enable

# 查看状态
sudo ufw status
```

**同时确保在腾讯云控制台的安全组中开放了80端口！**

---

## 第三步：克隆项目

### 3.1 创建部署目录
```bash
sudo mkdir -p /var/www/pdf-search
sudo chown -R $USER:$USER /var/www/pdf-search
cd /var/www/pdf-search
```

### 3.2 克隆GitHub仓库
```bash
git clone https://github.com/sakura-snowy/pdf-circuit-search.git .
# 注意最后有个点 . 表示克隆到当前目录
```

### 3.3 验证文件
```bash
ls -la
# 应该看到 backend, frontend, pdfs 等目录
```

---

## 第四步：部署后端

### 4.1 安装后端依赖
```bash
cd /var/www/pdf-search/backend
npm install --production
```

### 4.2 配置环境变量
```bash
# 复制生产环境配置
cp .env.production .env

# 查看配置（可选）
cat .env
```

### 4.3 编译TypeScript代码
```bash
npm run build
# 编译后的文件在 dist/ 目录
```

### 4.4 使用PM2启动后端
```bash
cd /var/www/pdf-search/backend

# 启动服务
pm2 start dist/index.js --name pdf-search-backend

# 查看状态
pm2 status

# 查看日志
pm2 logs pdf-search-backend

# 设置开机自启
pm2 save
pm2 startup
# 会输出一条命令，复制并执行它
```

### 4.5 测试后端API
```bash
curl http://localhost:3001/health
# 应返回：{"status":"ok","timestamp":"..."}
```

---

## 第五步：部署前端

### 5.1 安装前端依赖
```bash
cd /var/www/pdf-search/frontend
npm install --legacy-peer-deps
```

### 5.2 构建前端
```bash
npm run build
# 构建产物在 dist/ 目录
```

### 5.3 验证构建结果
```bash
ls -lh dist/
# 应该看到 index.html, assets/ 等文件
```

---

## 第六步：上传PDF文件

### 方法1：从本地上传（推荐）

**在你的本地电脑上执行**（打开新的终端）：
```bash
# Windows PowerShell 或 CMD
scp -r "C:\Users\sakura\OneDrive\桌面\pdf\*.pdf" root@你的服务器IP:/var/www/pdf-search/pdfs/

# 例如：
# scp -r "C:\Users\sakura\OneDrive\桌面\pdf\*.pdf" root@123.456.789.0:/var/www/pdf-search/pdfs/
```

### 方法2：在服务器上使用wget/curl下载
如果PDF文件在网上，可以直接在服务器下载：
```bash
cd /var/www/pdf-search/pdfs
wget https://your-url/file.pdf
```

### 方法3：使用FTP工具
使用FileZilla等FTP工具上传到 `/var/www/pdf-search/pdfs/` 目录

### 验证PDF文件
```bash
ls -lh /var/www/pdf-search/pdfs/
# 应该看到你的PDF文件
```

---

## 第七步：配置Nginx

### 7.1 编辑Nginx配置
```bash
cd /var/www/pdf-search

# 编辑nginx.conf，修改域名/IP
nano nginx.conf
```

**修改这一行**：
```nginx
server_name your_domain.com;
```
改为你的服务器IP：
```nginx
server_name 123.456.789.0;  # 替换为你的实际IP
```

按 `Ctrl+O` 保存，`Ctrl+X` 退出

### 7.2 复制配置到Nginx
```bash
# 复制配置文件
sudo cp nginx.conf /etc/nginx/sites-available/pdf-search

# 创建软链接
sudo ln -sf /etc/nginx/sites-available/pdf-search /etc/nginx/sites-enabled/pdf-search

# 删除默认配置（可选）
sudo rm -f /etc/nginx/sites-enabled/default

# 测试配置
sudo nginx -t
# 应显示：syntax is ok, test is successful
```

### 7.3 重启Nginx
```bash
sudo systemctl restart nginx

# 查看状态
sudo systemctl status nginx
```

---

## 第八步：验证部署

### 8.1 检查后端服务
```bash
pm2 status
# 应显示 pdf-search-backend 为 online 状态

curl http://localhost:3001/health
# 应返回 JSON 格式的健康检查信息
```

### 8.2 检查前端文件
```bash
ls -la /var/www/pdf-search/frontend/dist/
# 应该有 index.html 等文件
```

### 8.3 访问网站

**在浏览器中访问**：
```
http://你的服务器IP
```

例如：`http://123.456.789.0`

你应该能看到：
1. ✅ PDF文档列表页面
2. ✅ 可以点击查看PDF
3. ✅ 可以搜索关键词

---

## 常见问题排查

### 问题1：无法访问网站

**检查清单**：
```bash
# 1. 检查Nginx状态
sudo systemctl status nginx

# 2. 检查Nginx错误日志
sudo tail -f /var/log/nginx/error.log

# 3. 检查防火墙
sudo ufw status

# 4. 检查后端服务
pm2 status
pm2 logs pdf-search-backend
```

**腾讯云控制台检查**：
- 进入"安全组"设置
- 确保入站规则中有：
  - HTTP (80端口)
  - SSH (22端口)

### 问题2：API请求失败

```bash
# 检查后端日志
pm2 logs pdf-search-backend --lines 50

# 测试后端
curl http://localhost:3001/api/pdfs

# 重启后端
pm2 restart pdf-search-backend
```

### 问题3：PDF无法加载

```bash
# 检查PDF文件
ls -lh /var/www/pdf-search/pdfs/

# 检查文件权限
sudo chown -R www-data:www-data /var/www/pdf-search/pdfs/
sudo chmod -R 755 /var/www/pdf-search/pdfs/

# 检查后端日志
pm2 logs pdf-search-backend
```

---

## 后续管理

### 重启服务
```bash
# 重启后端
pm2 restart pdf-search-backend

# 重启Nginx
sudo systemctl restart nginx

# 重启全部
pm2 restart all && sudo systemctl restart nginx
```

### 查看日志
```bash
# 后端日志
pm2 logs pdf-search-backend

# Nginx访问日志
sudo tail -f /var/log/nginx/access.log

# Nginx错误日志
sudo tail -f /var/log/nginx/error.log
```

### 更新代码
```bash
cd /var/www/pdf-search

# 拉取最新代码
git pull

# 重新构建前端
cd frontend
npm run build

# 重新编译后端
cd ../backend
npm run build

# 重启后端服务
pm2 restart pdf-search-backend
```

---

## 配置HTTPS（可选但推荐）

### 使用Let's Encrypt免费证书

```bash
# 安装certbot
sudo apt install certbot python3-certbot-nginx

# 获取证书（需要域名）
sudo certbot --nginx -d your-domain.com

# 自动续期
sudo certbot renew --dry-run
```

---

## 完成！

🎉 恭喜！部署完成！

现在你的系统应该可以通过以下地址访问：
- **网站**: http://你的服务器IP
- **API**: http://你的服务器IP/api

**建议后续操作**：
1. 配置域名和HTTPS
2. 设置定期备份
3. 监控服务器资源使用情况

如有问题，查看 DEPLOY.md 或提交 GitHub Issue！
